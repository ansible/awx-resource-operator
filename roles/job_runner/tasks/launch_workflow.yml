- name: Launch a workflow, if error update AnsibleWorkflow status then end play
  block:
    - name: Launch workflow
      awx.awx.workflow_launch:
        name: "{{ lookup('env','TOWER_WORKFLOW_TEMPLATE_NAME') }}"
        extra_vars: "{{ ansible_workflow['resources'][0]['spec']['extra_vars'] | default(omit) }}"
        inventory: "{{ ansible_workflow['resources'][0]['spec']['inventory'] | default(omit) }}"
      register: workflow
  rescue:
    - name: Update status if workflow resulted in an error
      k8s_status:
        api_version: tower.ansible.com/v1alpha1
        kind: AnsibleWorkflow
        name: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAME') }}"
        namespace: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAMESPACE') }}"
        status:
          AnsibleWorkflowResult:
            status: "error"
    - name: End playbook run
      meta: end_play

- name: Update AnsibleWorkflow definition with Tower workflow id
  k8s:
    state: present
    definition:
      kind: AnsibleWorkflow
      apiVersion: tower.ansible.com/v1alpha1
      metadata:
        name: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAME') }}"
        namespace: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAMESPACE') }}"
        labels:
          tower_workflow_id: "{{ workflow.id }}"

- name: Update AnsibleWorkflow status with Tower workflow status and url
  k8s_status:
    api_version: tower.ansible.com/v1alpha1
    kind: AnsibleWorkflow
    name: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAME') }}"
    namespace: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAMESPACE') }}"
    status:
      ansibleWorkflowResult:
        changed: "{{ workflow.changed }}"
        failed: "{{ workflow.failed }}"
        status: "{{ workflow.status }}"
        url: "{{ lookup('env', 'TOWER_HOST') + '/#/jobs/workflow/' + (workflow.id|string) }}"

- name: Wait for the tower workflow, if error update AnsibleWorkflow status then end play
  block:
    - name: Register Job result when complete
      awx.awx.tower_job_wait:
        job_id: "{{ workflow.id }}"
        job_type: workflow_jobs
      register: workflow_result
  rescue:
    - name: Update status if workflow results in an error
      k8s_status:
        api_version: tower.ansible.com/v1alpha1
        kind: AnsibleWorkflow
        name: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAME') }}"
        namespace: "{{ lookup('env', 'ANSIBLEWORKFLOW_NAMESPACE') }}"
        status:
          ansibleWorkflowesult:
            status: "error"
    - name: End playbook run
      meta: end_play
